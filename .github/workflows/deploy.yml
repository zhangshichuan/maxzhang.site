name: Deploy to maxzhang.site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Prepare deployment artifacts
        run: |
          mkdir -p deployment/standalone
          mkdir -p deployment/static
          mkdir -p deployment/public

          # 复制 standalone 输出 (包含 server.js 和 必要的 node_modules)
          cp -r .next/standalone/. deployment/standalone/

          # 复制静态资源 (standalone 模式不包含这两部分，需要手动复制)
          cp -r .next/static/. deployment/static/
          cp -r public/. deployment/public/

          # 复制 Dockerfile
          cp Dockerfile deployment/

      - name: Archive production artifacts
        run: |
          cd deployment
          tar -czf ../release.tar.gz *

      - name: Upload release files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: 'release.tar.gz'
          target: ${{secrets.DEPLOY_PATH}}

      - name: Run deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{secrets.DEPLOY_PATH}}

            # 清理旧的构建文件
            rm -rf standalone static public Dockerfile

            # 解压新文件
            tar -xzf release.tar.gz
            rm release.tar.gz

            # 构建 Docker 镜像 (因为是纯 COPY 操作，速度极快且不耗资源)
            docker build -t maxzhang-site .

            # 停止并删除旧容器
            docker stop maxzhang-site-container || true
            docker rm maxzhang-site-container || true

            # 运行新容器
            docker run -d \
              --name maxzhang-site-container \
              --restart always \
              -p 3000:3000 \
              maxzhang-site

            # 清理
            docker image prune -f
